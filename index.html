<!DOCTYPE HTML>
<html>
<head>
<title>Graph Cyclemeter Data</title>
<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>
<link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/themes/smoothness/jquery-ui.css" />
<script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>
<script src="jquery.parse.min.js"></script>
<script src="http://code.highcharts.com/highcharts.js"></script>
<style>
.multi { float: left; margin: 5px; }
#mphchart { clear: both; width: 95%; height: 600px; }
#upload { clear: both; }
</style>
<script>
alldata = {};
routes = [];
bikes = [];

Highcharts.setOptions({ global: { useUTC: false } });

// http://dracoblue.net/dev/linear-least-squares-in-javascript/
function findLineByLeastSquares(values_x, values_y) {
    var sum_x = 0;
    var sum_y = 0;
    var sum_xy = 0;
    var sum_xx = 0;
    var count = 0;

    /*
     * We'll use those variables for faster read/write access.
     */
    var x = 0;
    var y = 0;
    var values_length = values_x.length;

    if (values_length != values_y.length) {
        throw new Error('The parameters values_x and values_y need to have same size!');
    }

    /*
     * Nothing to do.
     */
    if (values_length === 0) {
        return [ [], [] ];
    }

    /*
     * Calculate the sum for each of the parts necessary.
     */
    for (var v = 0; v < values_length; v++) {
        x = values_x[v];
        y = values_y[v];
        sum_x += x;
        sum_y += y;
        sum_xx += x*x;
        sum_xy += x*y;
        count++;
    }

    /*
     * Calculate m and b for the formular:
     * y = x * m + b
     */
    var m = (count*sum_xy - sum_x*sum_y) / (count*sum_xx - sum_x*sum_x);
    var b = (sum_y/count) - (m*sum_x)/count;

    /*
     * We will make the x and y result line now
     */
    var result_values_x = [];
    var result_values_y = [];

    for (var v = 0; v < values_length; v++) {
        x = values_x[v];
        y = x * m + b;
        result_values_x.push(x);
        result_values_y.push(y);
    }

    return [result_values_x, result_values_y];
}

function updatestats() {
  var activeroutes = $.map( $('#routes option:selected'), function(e) { return $(e).val(); } );
  var activebikes = $.map( $('#bikes option:selected'), function(e) { return $(e).val(); } );
  var groupby = $("#groupby").val();
  var totalrides = 0;
  var totalmiles = 0;
  var totalminutes = 0;
  var plotdata = {};
  var regx = [];
  var regy = [];
  $.each(alldata.results.rows, function(i, d) {
    if (!d.Route || (activeroutes.indexOf(d.Route)==-1) || (activebikes.indexOf(d.Bike)==-1))
      return;
    totalrides += 1;
    totalmiles += d["Distance (miles)"];
    var times = d.Time.split(":");
    totalminutes += parseInt(times[0])*60 + parseInt(times[1]) + parseInt(times[2])/60;
    if (plotdata[d[groupby]] == undefined)
      plotdata[d[groupby]] = [];
    plotdata[d[groupby]].push({
                             x: Date.parse(d["Start Time"]),
                             y: d["Average Speed (mph)"],
                             name: d.Route + ", " + d.Bike,
                             time: d.Time
                           });
    regx.push(Date.parse(d["Start Time"]));
    regy.push(d["Average Speed (mph)"]);
  });
  $("#totalrides").text(totalrides);
  $("#totalmiles").text(totalmiles.toFixed(1));
  $("#totalminutes").text((totalminutes/60).toFixed(0) + ":" + (totalminutes%60).toFixed(0));
  var rawreg = findLineByLeastSquares(regx, regy);
  var regline = [];
  for (var i=0; i<rawreg[0].length; i++) {
    regline.push({x: rawreg[0][i], y: rawreg[1][i]});
  }
  var allseries = [];
  for (var k in plotdata) {
    allseries.push({name: k, type: 'scatter', data: plotdata[k]});
  }
  allseries.push({
      type: 'line',
      data: regline,
      marker: { enabled: false },
      states: { hover: { lineWidth: 0 } },
      enableMouseTracking: false,
      showInLegend: false
  });
  $('#mphchart').highcharts({
    chart: {
    },
    title: {
      text: 'Ride Speed'
    },
    yAxis: {
      title: {
        text: 'MPH'
      }
    },
    xAxis: {
      type: 'datetime'
    },
    tooltip: {
      formatter: function() { return "<b>" + this.point.name + "</b><br/>" + Highcharts.dateFormat('%a %d %b %Y %I:%M %p',this.x) + ", " + this.y + "MPH, " + this.point.time; }
    },
    series: allseries,
  });
  $("#mphchart").show();
}

$(document).ready(function () {
  $(".multi").hide();
  $("#mphchart").hide();
  $("select").change(updatestats);
  $("#submit").click(function () {
    $('input[type=file]').parse({
      complete: function(data) {
        alldata = data;
        routes = [];
        bikes = [];
        $.each(data.results.rows, function(i, d) {
          if (!d.Route)
            return;
          if (routes.indexOf(d.Route) == -1) {
            $("#routes").append("<option selected>" + d.Route + "</option>");
            routes.push(d.Route);
          }
          if (bikes.indexOf(d.Bike) == -1) {
            $("#bikes").append("<option selected>" + d.Bike + "</option>");
            bikes.push(d.Bike);
          }
        });
        $(".multi").show();
        updatestats();
      }
    });
  });
});

</script>
<head>
<body class="ui-widget">

<h1>Graph Cyclemeter Rides</h1>

<div id="totals">
Totals - Rides: <span id="totalrides">0</span>, Miles: <span id="totalmiles">0</span>, Time: <span id="totalminutes">0</span>
</div>

<div class="multi">
<h3>Routes</h3>
<select multiple id="routes"></select>
</div>

<div class="multi">
<h3>Bikes</h3>
<select multiple id="bikes"></select>
</div>

<div class="multi">
<h3>Grouping</h3>
<select id="groupby">
<option>Route</option>
<option>Bike</option>
</select>
</div>

<div id="mphchart">
</div>

<div id="upload">
In Cyclemeter: History &gt; List All Rides &gt; ^ &gt; Export &gt; Email
&gt; CSV File Attachment<br>
CSV File: <input type="file" name="csvfile" size="20"><br>
<button id="submit">Upload</button>
</div>

</body>
</html>
